<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –§–æ—Ç–æ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      background: #000;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    #videoContainer {
      position: relative;
      width: 100%;
      flex: 1;
      overflow: hidden;
      border-radius: 12px;
      background: #111;
    }
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #canvas { display: none; }
    #controls {
      margin-top: 16px;
      display: flex;
      gap: 12px;
    }
    button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #captureBtn {
      background: #ff3b30;
      color: white;
    }
    #captureBtn:active:not(:disabled) {
      transform: scale(0.95);
    }
    #sendBtn {
      background: #34c759;
      color: white;
      display: none;
    }
    #sendBtn:active:not(:disabled) {
      transform: scale(0.95);
    }
    #flashBtn {
      background: #444;
      color: white;
      max-width: 120px;
    }
    #counter {
      text-align: center;
      margin: 12px 0;
      font-size: 18px;
      font-weight: 600;
    }
    .error {
      color: #ff3b30;
      text-align: center;
      padding: 20px;
    }
    #status { 
      text-align: center; 
      margin-top: 10px; 
      font-size: 14px;
      min-height: 20px;
    }
    
    /* Progress bar */
    #progressContainer {
      display: none;
      margin-top: 10px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      height: 8px;
    }
    #progressBar {
      height: 100%;
      background: linear-gradient(90deg, #34c759, #30d158);
      width: 0%;
      transition: width 0.3s;
    }
    
    /* Loader */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #34c759;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin: 10px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Success overlay */
    #successOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    #successOverlay.show {
      display: flex;
    }
    .success-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: scaleIn 0.5s ease-out;
    }
    .success-text {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .success-subtext {
      font-size: 16px;
      color: #ccc;
    }
    @keyframes scaleIn {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div id="videoContainer">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div id="counter">–°–¥–µ–ª–∞–Ω–æ —Ñ–æ—Ç–æ: <span id="count">0</span> / 6</div>

  <div id="controls">
    <button id="captureBtn">üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ</button>
    <button id="flashBtn" title="–í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –≤—Å–ø—ã—à–∫—É">‚ö° –í—ã–∫–ª</button>
    <button id="sendBtn">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
  </div>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>

  <div id="status"></div>
  
  <!-- Success overlay -->
  <div id="successOverlay">
    <div class="success-icon">‚úÖ</div>
    <div class="success-text">–§–æ—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!</div>
    <div class="success-subtext" id="successSubtext">–ó–∞–∫—Ä—ã—Ç–∏–µ...</div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const captureBtn = document.getElementById('captureBtn');
    const sendBtn = document.getElementById('sendBtn');
    const flashBtn = document.getElementById('flashBtn');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');
    const successOverlay = document.getElementById('successOverlay');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const successSubtext = document.getElementById('successSubtext');

    // Server URL - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–∞–ª—å–Ω—ã–π endpoint
    const SERVER_URL = 'https://down-8vvo.onrender.com/upload_photos';

    let photos = [];
    let photoCount = 0;
    const MAX_PHOTOS = 6;
    const MIN_PHOTOS = 4;

    const tg = window.Telegram ? window.Telegram.WebApp : null;
    if (tg) {
      try { 
        tg.ready(); 
        tg.expand();
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–æ–¥ —Ç–µ–º—É Telegram
        if (tg.themeParams) {
          document.body.style.background = tg.themeParams.bg_color || '#000';
        }
      } catch(e) { 
        console.warn('tg init', e); 
      }
    }

    // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: 'environment',
        width: { ideal: 1280 },  // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        height: { ideal: 720 }   // –£–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
      } 
    })
      .then(stream => {
        video.srcObject = stream;
        video.play();
        window._videoTrack = stream.getVideoTracks && stream.getVideoTracks()[0];
        
        if (window._videoTrack) {
          try {
            const caps = window._videoTrack.getCapabilities && window._videoTrack.getCapabilities();
            if (caps && caps.torch) {
              statusEl.textContent = 'üí° –í—Å–ø—ã—à–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞';
            } else {
              statusEl.textContent = 'üì∑ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞';
            }
          } catch (e) {
            console.warn('getCapabilities failed', e);
            statusEl.textContent = 'üì∑ –ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞';
          }
        }
      })
      .catch(err => {
        document.body.innerHTML = `<div class="error">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.<br><br>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Telegram.</div>`;
        console.error("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:", err);
      });

    // –°—ä–µ–º–∫–∞ —Ñ–æ—Ç–æ
    captureBtn.onclick = () => {
      if (photoCount >= MAX_PHOTOS) {
        statusEl.textContent = '‚ö†Ô∏è –î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º —Ñ–æ—Ç–æ (6)';
        return;
      }

      // –û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
      canvas.width = Math.min(video.videoWidth || 1280, 1280);
      canvas.height = Math.min(video.videoHeight || 720, 720);

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º JPEG —Å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º (–±–∞–ª–∞–Ω—Å –∫–∞—á–µ—Å—Ç–≤–æ/—Ä–∞–∑–º–µ—Ä)
      const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
      photos.push(dataUrl);
      photoCount++;

      countEl.textContent = photoCount;
      
      // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
      captureBtn.textContent = '‚úÖ –°–Ω—è—Ç–æ!';
      setTimeout(() => {
        captureBtn.textContent = 'üì∏ –°–¥–µ–ª–∞—Ç—å —Ñ–æ—Ç–æ';
      }, 300);

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –º–∏–Ω–∏–º—É–º–∞
      if (photoCount >= MIN_PHOTOS) {
        sendBtn.style.display = 'block';
        sendBtn.textContent = `‚úÖ –ì–æ—Ç–æ–≤–æ (${photoCount})`;
      }

      if (photoCount === MAX_PHOTOS) {
        captureBtn.disabled = true;
        captureBtn.textContent = '‚úÖ –í—Å–µ —Ñ–æ—Ç–æ —Å–¥–µ–ª–∞–Ω—ã';
        statusEl.textContent = `‚úÖ –ì–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏—Ç–µ "–ì–æ—Ç–æ–≤–æ" –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏`;
      } else {
        statusEl.textContent = `üì∏ ${photoCount} –∏–∑ ${MAX_PHOTOS} (–º–∏–Ω–∏–º—É–º ${MIN_PHOTOS})`;
      }
    };

    // –í—Å–ø—ã—à–∫–∞
    let flashEnabled = false;

    function updateFlashButton() {
      flashBtn.textContent = flashEnabled ? '‚ö° –í–∫–ª' : '‚ö° –í—ã–∫–ª';
      flashBtn.style.background = flashEnabled ? '#ffd60a' : '#444';
      flashBtn.style.color = flashEnabled ? '#000' : '#fff';
    }

    async function setTorch(on) {
      const track = window._videoTrack;
      if (!track) return false;
      
      const caps = track.getCapabilities && track.getCapabilities();
      if (caps && caps.torch) {
        try {
          await track.applyConstraints({ advanced: [{ torch: on }] });
          return true;
        } catch (err) {
          console.warn('torch error', err);
          return false;
        }
      }
      return false;
    }

    flashBtn.addEventListener('click', async () => {
      const desired = !flashEnabled;
      const ok = await setTorch(desired);
      if (ok) {
        flashEnabled = desired;
        updateFlashButton();
        statusEl.textContent = flashEnabled ? '‚ö° –í—Å–ø—ã—à–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞' : 'üì∑ –í—Å–ø—ã—à–∫–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞';
      } else {
        statusEl.textContent = '‚ö†Ô∏è –í—Å–ø—ã—à–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
      }
    });

    updateFlashButton();

    // –£—Ç–∏–ª–∏—Ç–∞: dataURL -> Blob (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
    function dataURLToBlob(dataURL) {
      const parts = dataURL.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const binary = atob(parts[1]);
      const array = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        array[i] = binary.charCodeAt(i);
      }
      return new Blob([array], { type: mime });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
    async function uploadToServer(url) {
      const form = new FormData();
      form.append('photoCount', photos.length);
      
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Ñ–æ—Ç–æ –≤ Blob
      const blobs = photos.map((dataUrl, idx) => {
        const blob = dataURLToBlob(dataUrl);
        console.log(`–§–æ—Ç–æ ${idx}: ${(blob.size / 1024).toFixed(2)} KB`);
        return blob;
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      progressContainer.style.display = 'block';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–±—ã –≤ —Ñ–æ—Ä–º—É
      blobs.forEach((blob, idx) => {
        form.append('photo' + idx, blob, `photo_${idx}.jpg`);
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–æ—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
      if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        form.append('user_id', tg.initDataUnsafe.user.id);
      }

      // –°–∏–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += 10;
        if (progress < 90) {
          progressBar.style.width = progress + '%';
        }
      }, 200);

      try {
        const resp = await fetch(url, {
          method: 'POST',
          body: form
        });

        clearInterval(progressInterval);
        progressBar.style.width = '100%';

        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${resp.status}`);
        }

        return await resp.json().catch(() => ({ success: true }));
      } catch (err) {
        clearInterval(progressInterval);
        throw err;
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è WebApp
    function closeWebApp() {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
      if (window._videoTrack) {
        try {
          window._videoTrack.stop();
        } catch(e) {}
      }
      
      // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∑–∞–∫—Ä—ã—Ç–∏—è
      if (tg) {
        try {
          tg.close();
        } catch(e) {
          console.warn('tg.close() failed', e);
        }
      }
      
      // Fallback: –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
      try {
        window.close();
      } catch(e) {
        console.warn('window.close() failed', e);
      }
    }

    // –ü–æ–∫–∞–∑ —É—Å–ø–µ—Ö–∞
    function showSuccess() {
      successOverlay.classList.add('show');
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –±–æ—Ç–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –°–†–ê–ó–£
      if (tg) {
        try {
          tg.sendData(JSON.stringify({ 
            action: 'uploaded_to_server', 
            photoCount: photoCount 
          }));
          console.log('Sent data to bot:', photoCount);
        } catch(e) {
          console.warn('sendData failed', e);
        }
      }
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ù–ï–ú–ï–î–õ–ï–ù–ù–û (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏)
      closeWebApp();
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
      setTimeout(() => closeWebApp(), 100);
      setTimeout(() => closeWebApp(), 300);
      setTimeout(() => closeWebApp(), 500);
    }

    // –ü–æ–∫–∞–∑ –æ—à–∏–±–∫–∏
    function showError(message) {
      statusEl.innerHTML = '‚ùå ' + message;
      statusEl.style.color = '#ff3b30';
      progressContainer.style.display = 'none';
      
      if (tg) {
        try {
          tg.showAlert('–û—à–∏–±–∫–∞: ' + message);
        } catch(e) {
          alert('–û—à–∏–±–∫–∞: ' + message);
        }
      } else {
        alert('–û—à–∏–±–∫–∞: ' + message);
      }
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞
    sendBtn.onclick = async () => {
      if (photoCount < MIN_PHOTOS) {
        showError(`–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –º–∏–Ω–∏–º—É–º ${MIN_PHOTOS} —Ñ–æ—Ç–æ (—Å–¥–µ–ª–∞–Ω–æ: ${photoCount})`);
        return;
      }

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏
      sendBtn.disabled = true;
      captureBtn.disabled = true;
      flashBtn.disabled = true;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      statusEl.innerHTML = '<div class="loader"></div><br>–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ...';
      statusEl.style.color = 'white';
      sendBtn.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const startTime = Date.now();
        await uploadToServer(SERVER_URL);
        const duration = ((Date.now() - startTime) / 1000).toFixed(1);
        console.log(`Upload completed in ${duration}s`);
        
        // –£—Å–ø–µ—Ö!
        showSuccess();
        
      } catch (err) {
        console.error('Upload error:', err);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        sendBtn.disabled = false;
        captureBtn.disabled = false;
        flashBtn.disabled = false;
        sendBtn.textContent = `‚úÖ –ì–æ—Ç–æ–≤–æ (${photoCount})`;
        
        showError(err.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
      }
    };

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è WebApp
    if (tg) {
      window.addEventListener('beforeunload', () => {
        // –û—Ç–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        if (window._videoTrack) {
          try {
            window._videoTrack.stop();
          } catch(e) {}
        }
      });
    }

  </script>
</body>
</html>
